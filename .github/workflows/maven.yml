name: Build and Deploy to AKS

on:
  push:
    branches: [ "main" ]

env:
  ACR_NAME: acrhyosungdev
  IMAGE_NAME: demo-app
  AKS_CLUSTER: aks-hyosung-dev
  AKS_RESOURCE_GROUP: rg-hyosung-dev
  K8S_NAMESPACE: dev

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Login to ACR using Managed Identity
      run: |
        az login --identity
        az acr login --name ${{ env.ACR_NAME }}

    - name: Build and Push Docker Image
      run: |
        IMAGE_TAG=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker build -t $IMAGE_TAG .
        docker push $IMAGE_TAG
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Deploy to AKS
      run: |
        az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER }}
        
        # Update image tag in manifest
        sed -i "s|image:.*|image: ${{ env.IMAGE_TAG }}|g" k8s/deployment.yaml
        
        # Apply or update deployment
        kubectl apply -f k8s/deployment.yaml -n ${{ env.K8S_NAMESPACE }}
        kubectl rollout status deployment/demo-app -n ${{ env.K8S_NAMESPACE }}
